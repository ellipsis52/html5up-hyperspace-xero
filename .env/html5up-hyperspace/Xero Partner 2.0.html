import zipfile
import os

# Recréer la structure après reset
base_path = "/mnt/data/hyperspace-xero"
os.makedirs(f"{base_path}/assets/css", exist_ok=True)
os.makedirs(f"{base_path}/assets/js", exist_ok=True)
os.makedirs(f"{base_path}/images", exist_ok=True)

# Fichiers HTML/CSS/JS
index_html = """<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Hyperspace Xero</title>
  <link rel="stylesheet" href="assets/css/main.css" />
</head>
<body>
  <header>
    <h1>welcome to Xero Partner 2.0</h1>
    <ul>
      <li><a href="dashboard.html">📊 Access to Dashboard Xero</a></li>
      <li><a href="https://auth.netmanagement.online">🔐 Connexion Auth0</a></li>
      <li><a href="https://gpt.netmanagement.online">💬 Talk to  GPT5</a></li>
    </ul>
  </header>
</body>
</html>
"""

dashboard_html = """<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Xero</title>
  <link rel="stylesheet" href="assets/css/main.css" />
  <style>
    body { font-family: sans-serif; padding: 2em; background: #1d1f20; color: #eee; }
    input, button { padding: 0.5em; margin: 0.2em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { padding: 0.5em; border: 1px solid #444; }
    .loader { font-style: italic; color: #aaa; }
  </style>
</head>
<body>
  <h2>Transactions Dashboard</h2>
  <input id="token" placeholder="Bearer Token" />
  <input id="search" placeholder="Rechercher..." />
  <button onclick="fetchTransactions()">🔄 Rafraîchir</button>
  <button onclick="exportCSV()">📄 Export CSV</button>
  <div id="loader" class="loader"></div>
  <table id="results">
    <thead><tr><th>Client</th><th>ID</th><th>Montant</th><th>Devise</th><th>Status</th><th>Date</th></tr></thead>
    <tbody></tbody>
  </table>
  <script src="assets/js/dashboard.js"></script>
</body>
</html>
"""

dashboard_js = """
let transactions = [];
async function fetchTransactions() {
  const token = document.getElementById('token').value;
  document.getElementById('loader').innerText = "🔄 Chargement...";
  try {
    const res = await fetch('/transactions/history', {
      headers: { Authorization: `Bearer ${token}` }
    });
    transactions = await res.json();
    renderTransactions();
  } catch (e) {
    document.getElementById('loader').innerText = "❌ Erreur de chargement";
    console.error(e);
  }
}

function renderTransactions() {
  const tbody = document.querySelector("#results tbody");
  const search = document.getElementById('search').value.toLowerCase();
  tbody.innerHTML = '';
  const filtered = transactions.filter(t =>
    t.client_name.toLowerCase().includes(search) ||
    t.id.toLowerCase().includes(search)
  );
  filtered.forEach(t => {
    const row = `<tr>
      <td>${t.client_name}</td>
      <td>${t.id}</td>
      <td>${t.amount}</td>
      <td>${t.currency}</td>
      <td>${t.status}</td>
      <td>${t.timestamp}</td>
    </tr>`;
    tbody.innerHTML += row;
  });
  document.getElementById('loader').innerText = `${filtered.length} transactions trouvées`;
}

function exportCSV() {
  const headers = ["Client Name", "Invoice ID", "Amount", "Currency", "Status", "Timestamp"];
  const rows = transactions.map(t => [t.client_name, t.id, t.amount, t.currency, t.status, t.timestamp]);
  const csv = [headers, ...rows].map(e => e.join(",")).join("\\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'transactions.csv';
  a.click();
}
document.getElementById('search').addEventListener('input', renderTransactions);
"""

main_css = "/* Placeholder CSS for Hyperspace */\nbody { background: #111; color: #eee; font-family: sans-serif; }"

# Écriture
with open(f"{base_path}/index.html", "w") as f: f.write(index_html)
with open(f"{base_path}/dashboard.html", "w") as f: f.write(dashboard_html)
with open(f"{base_path}/assets/js/dashboard.js", "w") as f: f.write(dashboard_js)
with open(f"{base_path}/assets/css/main.css", "w") as f: f.write(main_css)

# ZIP
zip_path = "/mnt/data/hyperspace-xero-ready.zip"
with zipfile.ZipFile(zip_path, 'w') as zipf:
    for foldername, subfolders, filenames in os.walk(base_path):
        for filename in filenames:
            file_path = os.path.join(foldername, filename)
            arcname = os.path.relpath(file_path, base_path)
            zipf.write(file_path, arcname)

zip_path
